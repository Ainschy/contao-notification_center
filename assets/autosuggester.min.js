var AutoSuggester=new Class({Implements:Options,options:{rgxp:"[^ ]+$",class_input_mirror:"autosuggester-input-mirror",class_input_mirror_container:"autosuggester-input-mirror-container",class_input_mirror_caret:"autosuggester-input-mirror-caret",class_box:"autosuggester-box",class_box_container:"autosuggester-box-container",class_box_list:"autosuggester-box-list",class_box_list_item:"autosuggester-box-list-item",class_box_list_item_active:"autosuggester-box-list-item-active",class_box_list_item_value:"autosuggester-box-list-item-value",class_box_list_item_content:"autosuggester-box-list-item-content",},keys_mapper:{13:"enter",27:"esc",38:"up",40:"down"},initialize:function(b,c,a){this.input=b;this.setOptions(a);this.source=c;this.tinyMCE=false;this.rgxp=new RegExp(this.options.rgxp,"i");this.input.set("autocomplete","off");setTimeout((function(){if(window.tinyMCE){try{this.tinyMCE=tinyMCE.get(this.input.get("id"))}catch(d){}}if(this.input.get("tag")=="textarea"&&!this.tinyMCE){this.setUpMirror()}this.setUpSuggestions();this.registerObservers()}).bind(this),500)},setUpSuggestions:function(){var b,a;this.box_container=new Element("div",{"class":this.options.class_box_container});this.box=new Element("div",{id:this.input.get("id")+"_autosuggester","class":this.options.class_box});this.box_list=new Element("ul",{"class":this.options.class_box_list});this.box_list_items=[];this.box_list_items_visible=[];for(b=0;b<this.source.length;b+=1){this.box_list_items[b]=new Element("li",{"class":this.options.class_box_list_item,html:'<div class="'+this.options.class_box_list_item_value+'">'+this.source[b]["value"]+'</div><div class="'+this.options.class_box_list_item_content+'">'+this.source[b]["content"]+"</div>"}).inject(this.box_list);this.box_list_items_visible.push(b)}this.box_list.inject(this.box);this.box.inject(this.box_container);this.box_container.inject(document.body);this.box_visible=false},setUpMirror:function(){var c=["box-sizing","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","line-height","max-height","min-height","padding-bottom","padding-left","padding-right","padding-top","text-decoration","text-indent","text-transform","width","word-spacing"];var b=window.getComputedStyle(this.input);var a;this.input_mirror=new Element("div",{"class":this.options.class_input_mirror,text:this.input.get("value")});this.input_mirror_caret=new Element("span",{"class":this.options.class_input_mirror_caret,html:"&nbsp;"});for(a=0;a<c.length;a++){this.input_mirror.setStyle(c[a],b[c[a]])}this.input_mirror_caret.inject(this.input_mirror);this.input_mirror.inject(this.input,"after")},registerObservers:function(){var a;if(!this.tinyMCE){this.input.addEvents({keyup:this.eventKeyUp.bind(this),keydown:this.eventKeyDown.bind(this)})}if(this.tinyMCE){this.tinyMCE.onKeyUp.add((function(b,c){this.eventKeyUp.call(this,c)}).bind(this));this.tinyMCE.onKeyDown.listeners=[];this.tinyMCE.onKeyDown.add((function(b,c){this.eventKeyDown.call(this,c)}).bind(this))}for(a=0;a<this.box_list_items.length;a++){this.box_list_items[a].addEvents({mouseenter:(function(b){this.highlightItem(this.box_list_items.indexOf(b.target))}).bind(this),click:(function(b){b.preventDefault();this.selectItem()}).bind(this)})}},showBox:function(){if(!this.box_visible){var b,c,d;var a={x:0,y:0};if(this.tinyMCE){a.x=this.tinyMCE.selection.getRng().getClientRects()[0].left;a.y=this.tinyMCE.selection.getNode().getClientRects()[0].top+this.tinyMCE.selection.getNode().getClientRects()[0].height}else{if(this.input_mirror){b=this.getCaretIndex();c=this.input.get("value");d=[c.substr(0,b),c.substr(b,c.length)];this.input_mirror.set("html","");this.input_mirror.grab(document.createTextNode(d[0]));this.input_mirror.grab(this.input_mirror_caret);this.input_mirror.grab(document.createTextNode(d[1]));a=this.input_mirror_caret.getPosition(this.input_mirror);a.y=a.y+this.input_mirror_caret.getSize().y}else{a.y=this.input.getSize().y}}for(i=0;i<this.box_list_items.length;i++){this.box_list_items[i].removeClass("invisible")}if(this.tinyMCE){this.setPosition(this.box_container,$(this.input.get("id")+"_ifr").getPosition())}else{this.setPosition(this.box_container,this.input.getPosition())}this.current_list_item=null;this.box.setStyle("display","block");this.setPosition(this.box,a);this.box.scrollTo(0,0);this.box_visible=true;document.body.addEvent("click",this.hideBox.bind(this))}},hideBox:function(){this.box.setStyle("display","none");this.box_visible=false;for(i=0;i<this.box_list_items.length;i++){this.box_list_items[i].removeClass(this.options.class_box_list_item_active)}},eventKeyUp:function(f){if(this.getKeyCode(f)=="esc"){return}var g,b,e,d,a;var c=true;if(this.tinyMCE){e=this.tinyMCE.selection.getRng();g=e.startContainer.wholeText;b=e.startOffset;if(g&&b==e.startContainer.length&&e.startContainer.textContent.length!=g.length){b=b+(g.length-e.startContainer.textContent.length)}}else{g=this.input.get("value");b=this.getCaretIndex()}if(!g){this.hideBox();return}this.filter_text="";g=g.slice(0,b);a=this.rgxp.exec(g);if(a){this.showBox();this.filter_text=a[0];if(!this.filterItems()){this.hideBox()}}},eventKeyDown:function(b){if(!this.box_visible){return}var a=this.box_list_items_visible.indexOf(this.current_list_item);switch(this.getKeyCode(b)){case"esc":this.hideBox();break;case"enter":if(this.current_list_item===null){return}b.preventDefault();this.selectItem();break;case"up":b.preventDefault();if(a===-1){this.highlightItem(this.box_list_items_visible.length-1)}else{if(a>0){this.highlightItem(this.box_list_items_visible[a-1])}}break;case"down":b.preventDefault();if(a===-1){this.highlightItem(this.box_list_items_visible[0])}else{if(a<this.box_list_items_visible.length-1){this.highlightItem(this.box_list_items_visible[a+1])}}break}},highlightItem:function(b){var c=parseInt(this.box.getStyle("maxHeight"));var a=this.box.getScroll().y;var d=c+a;var f=this.box_list_items[b].getPosition(this.box).y+a;var e=f+this.box_list_items[b].getCoordinates().height;if(this.current_list_item!==null){this.box_list_items[this.current_list_item].removeClass(this.options.class_box_list_item_active)}this.box_list_items[b].addClass(this.options.class_box_list_item_active);this.current_list_item=b;if(e>=d){this.box.scrollTo(0,((e-c>0)?(e-c):0))}else{if(f<a){this.box.scrollTo(0,f)}}},selectItem:function(){var d,a,b;var c=this.source[this.current_list_item]["value"];if(this.tinyMCE){this.tinyMCE.selection.setContent(c)}else{d=this.input.get("value");a=this.getCaretIndex();this.input.set("value",d.slice(0,a-this.filter_text.length)+c+d.slice(a,d.length))}this.hideBox()},filterItems:function(){var c,b;var a=new RegExp("^"+this.filter_text+"(?!$)","i");for(c=0;c<this.box_list_items.length;c++){if(a.test(this.source[c]["value"])){this.box_list_items[c].removeClass("invisible");this.box_list_items_visible.include(c)}else{this.box_list_items[c].addClass("invisible");this.box_list_items_visible.erase(c)}}return this.box_list_items_visible.length>0},getCaretIndex:function(){return this.input.selectionStart},getKeyCode:function(b){var a;if(this.tinyMCE){a=b.keyCode}else{a=b.event.keyCode}return this.keys_mapper[a]},setPosition:function(b,a){b.setStyle("left",a.x);b.setStyle("top",a.y)}});